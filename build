#!/bin/bash -e
cd $(dirname $0)

PATH=$HOME/go/bin:$PATH
unset GOPATH

go mod download

./builtintest/clean

./copy-threadsafe-builtins

./get-statics-tool

go generate .

echo -e "// git: \"$(git describe --tags 2>/dev/null)\"" >> app/statics.go
fgrep const version.go >> app/statics.go

echo
echo App Testing...
go test ./app/...

echo
echo Installing...
go install .

type runtemplate

builtin/info

echo
echo Generating tests...
go generate -v ./builtintest/...

rm -f examples/*_*.go
go generate ./examples

gofmt -l -w examples/*.go

echo
echo Template Testing...
go test ./...

echo
echo Code vetting...
go vet ./...

echo ok.
